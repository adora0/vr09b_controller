<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roland VR-09B Controller</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: #d51c1c;
            color: white;
            padding: 15px;
            text-align: center;
            border-radius: 8px 8px 0 0;
        }

        .connection-status {
            background-color: #e5e5e5;
            padding: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 0 0 8px 8px;
        }

        .connect-btn {
            background-color: #2a9d8f;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .connect-btn:disabled {
            background-color: #ccc;
        }

        .tab-container {
            margin-top: 20px;
        }

        .tab-buttons {
            display: flex;
            background-color: #e5e5e5;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
        }

        .tab-btn {
            padding: 12px 20px;
            background-color: #e5e5e5;
            border: none;
            flex-grow: 1;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .tab-btn.active {
            background-color: #d51c1c;
            color: white;
        }

        .tab-content {
            background-color: white;
            padding: 20px;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .control-group {
            margin-bottom: 25px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }

        .control-group h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #d51c1c;
        }

        .parameter {
            margin-bottom: 15px;
        }

        .parameter label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .parameter .slider-container {
            display: flex;
            align-items: center;
        }

        .parameter input[type="range"] {
            flex-grow: 1;
            margin-right: 10px;
        }

        .parameter .value {
            min-width: 40px;
            text-align: right;
        }

        select {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        /* Stile specifico per gli switch */
        .switch-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 5px;
        }

        .switch-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 7px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }

        .switch-item label {
            font-weight: bold;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #d51c1c;
        }

        input:focus+.slider {
            box-shadow: 0 0 1px #d51c1c;
        }

        input:checked+.slider:before {
            transform: translateX(26px);
        }

        .switch-status {
            font-size: 14px;
            margin-left: 10px;
        }

        .send-all-btn {
            background-color: #d51c1c;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 20px;
            width: 100%;
        }

        .logs {
            margin-top: 20px;
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 4px;
            max-height: 150px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            border: 1px solid #eee;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .success {
            color: #2a9d8f;
        }

        .error {
            color: #d51c1c;
        }

        .info {
            color: #2b50aa;
        }

        @media (max-width: 600px) {
            .tab-btn {
                padding: 8px 12px;
                font-size: 14px;
            }

            .tab-content {
                padding: 15px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Roland VR-09B Controller</h1>
        </header>

        <div class="connection-status">
            <div id="status">Stato: Non connesso</div>
            <button id="connect-btn" class="connect-btn">Connetti MIDI</button>
        </div>
        <div class="tab-container">
            <div class="tab-content">
                <div class="tab-container">
                    <div class="tab-content">
                        <div class="control-group"
                            style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
                            <div style="display: flex; justify-content: center; align-items: center; gap: 30px;">
                                <div class="switch-item" style="margin: 0;">
                                    <label style="margin-right: 5px;">OSC1</label>
                                    <label class="switch" style="transform: scale(0.8);">
                                        <input type="checkbox" id="switch1">
                                        <span class="slider"></span>
                                    </label>
                                </div>

                                <div class="switch-item" style="margin: 0;">
                                    <label style="margin-right: 5px;">OSC2</label>
                                    <label class="switch" style="transform: scale(0.8);">
                                        <input type="checkbox" id="switch2">
                                        <span class="slider"></span>
                                    </label>
                                </div>

                                <div class="switch-item" style="margin: 0;">
                                    <label style="margin-right: 5px;">OSC3</label>
                                    <label class="switch" style="transform: scale(0.8);">
                                        <input type="checkbox" id="switch3">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>

                            <div style="display: flex; align-items: center; font-size: 1.2rem; gap: 15px;">
                                <label style="margin-right: 15px;">Invia parametri a :</label>
                                <div style="display: flex; gap: 10px;">
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input id="radioosc0" type="radio" name="osc-wave-variation" value="0" checked
                                            style="transform: scale(1.5);">
                                        <span style="margin-right: 2ch;">All</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input id="radioosc1" type="radio" name="osc-wave-variation" value="1"
                                            style="transform: scale(1.5);">
                                        <span style="margin-right: 25px;">1</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input id="radioosc2" type="radio" name="osc-wave-variation" value="2"
                                            style="transform: scale(1.5);">
                                        <span style="margin-right: 25px;">2</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input id="radioosc3" type="radio" name="osc-wave-variation" value="3"
                                            style="transform: scale(1.5);">
                                        <span style="margin-right: 25px;">3</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-buttons">
                    <button class="tab-btn active" data-tab="oscillator">Oscillatore</button>
                    <button class="tab-btn" data-tab="filter">Filtro</button>
                    <button class="tab-btn" data-tab="lfo">LFO</button>
                </div>
                <div class="tab-content">
                    <!-- Oscillator Tab -->
                    <div id="oscillator" class="tab-panel">
                        <div class="control-group">
                            <h3>Parametri Oscillatore</h3>
                            <div class="parameter">
                                <label for="osc-wave">Forma d'onda</label>
                                <select id="osc-wave">
                                    <option value="0">SAW</option>
                                    <option value="1">SQR</option>
                                    <option value="2">PW-SQR</option>
                                    <option value="3">TRI</option>
                                    <option value="4">SINE</option>
                                    <option value="5">NOISE</option>
                                    <option value="6">SUPER-SAW</option>
                                    <option value="7">PCM</option>
                                </select>
                            </div>

                            <div class="parameter">
                                <label for="osc-pitch">Pitch (40-88) [-24 - +24]</label>
                                <div class="slider-container">
                                    <input type="range" id="osc-pitch" min="40" max="88" value="64">
                                    <span class="value" id="osc-pitch-value">0</span>
                                </div>
                            </div>

                            <div class="parameter">
                                <label for="osc-detune">Detune (14-114) [-50 - +50]</label>
                                <div class="slider-container">
                                    <input type="range" id="osc-detune" min="14" max="114" value="64">
                                    <span class="value" id="osc-detune-value">0</span>
                                </div>
                            </div>

                            <div class="parameter">
                                <label for="osc-pw-mod-depth">Pulse Width Mod Depth (0-127)</label>
                                <div class="slider-container">
                                    <input type="range" id="osc-pw-mod-depth" min="0" max="127" value="64">
                                    <span class="value" id="osc-pw-mod-depth-value">64</span>
                                </div>
                            </div>

                            <div class="parameter">
                                <label for="osc-pw">Pulse Width (0-127)</label>
                                <div class="slider-container">
                                    <input type="range" id="osc-pw" min="0" max="127" value="64">
                                    <span class="value" id="osc-pw-value">64</span>
                                </div>
                            </div>

                            <div class="parameter">
                                <label for="osc-pitch-env-attack">Pitch Env Attack Time (0-127)</label>
                                <div class="slider-container">
                                    <input type="range" id="osc-pitch-env-attack" min="0" max="127" value="0">
                                    <span class="value" id="osc-pitch-env-attack-value">0</span>
                                </div>
                            </div>

                            <div class="parameter">
                                <label for="osc-pitch-env-decay">Pitch Env Decay (0-127)</label>
                                <div class="slider-container">
                                    <input type="range" id="osc-pitch-env-decay" min="0" max="127" value="0">
                                    <span class="value" id="osc-pitch-env-decay-value">0</span>
                                </div>
                            </div>

                            <div class="parameter">
                                <label for="osc-pitch-env-depth">Pitch Env Depth (1-127) [-63 - +63]</label>
                                <div class="slider-container">
                                    <input type="range" id="osc-pitch-env-depth" min="1" max="127" value="64">
                                    <span class="value" id="osc-pitch-env-depth-value">0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filter Tab -->
                    <div id="filter" class="tab-panel" style="display: none;">
                        <div class="control-group">
                            <h3>Parametri Filtro</h3>

                            <div class="parameter">
                                <label for="filter-mode">Modalità Filtro</label>
                                <select id="filter-mode">
                                    <option value="0">BYPASS</option>
                                    <option value="1">LPF</option>
                                    <option value="2">HPF</option>
                                    <option value="3">BPF</option>
                                    <option value="4">PKG</option>
                                </select>
                            </div>

                            <div class="parameter">
                                <label for="filter-slope">Pendenza Filtro</label>
                                <select id="filter-slope">
                                    <option value="0">-12 dB</option>
                                    <option value="1">-24 dB</option>
                                </select>
                            </div>

                            <div class="parameter">
                                <label for="filter-cutoff">Cutoff (0-127)</label>
                                <div class="slider-container">
                                    <input type="range" id="filter-cutoff" min="0" max="127" value="127">
                                    <span class="value" id="filter-cutoff-value">127</span>
                                </div>
                            </div>

                            <div class="parameter">
                                <label for="filter-cutoff-keyfollow">Cutoff Keyfollow (54-74) [-100 - +100]</label>
                                <div class="slider-container">
                                    <input type="range" id="filter-cutoff-keyfollow" min="54" max="74" value="64">
                                    <span class="value" id="filter-cutoff-keyfollow-value">0</span>
                                </div>
                            </div>

                            <div class="parameter">
                                <label for="filter-resonance">Resonance (0-127)</label>
                                <div class="slider-container">
                                    <input type="range" id="filter-resonance" min="0" max="127" value="0">
                                    <span class="value" id="filter-resonance-value">0</span>
                                </div>
                            </div>
                        </div>

                        <div class="control-group">
                            <h3>Inviluppo Filtro</h3>

                            <div class="parameter">
                                <label for="filter-env-attack">Attack Time (0-127)</label>
                                <div class="slider-container">
                                    <input type="range" id="filter-env-attack" min="0" max="127" value="0">
                                    <span class="value" id="filter-env-attack-value">0</span>
                                </div>
                            </div>

                            <div class="parameter">
                                <label for="filter-env-decay">Decay Time (0-127)</label>
                                <div class="slider-container">
                                    <input type="range" id="filter-env-decay" min="0" max="127" value="0">
                                    <span class="value" id="filter-env-decay-value">0</span>
                                </div>
                            </div>

                            <div class="parameter">
                                <label for="filter-env-sustain">Sustain Level (0-127)</label>
                                <div class="slider-container">
                                    <input type="range" id="filter-env-sustain" min="0" max="127" value="127">
                                    <span class="value" id="filter-env-sustain-value">127</span>
                                </div>
                            </div>

                            <div class="parameter">
                                <label for="filter-env-release">Release Time (0-127)</label>
                                <div class="slider-container">
                                    <input type="range" id="filter-env-release" min="0" max="127" value="0">
                                    <span class="value" id="filter-env-release-value">0</span>
                                </div>
                            </div>

                            <div class="parameter">
                                <label for="filter-env-depth">Depth (1-127) [-63 - +63]</label>
                                <div class="slider-container">
                                    <input type="range" id="filter-env-depth" min="1" max="127" value="64">
                                    <span class="value" id="filter-env-depth-value">0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- LFO Tab -->
                    <div id="lfo" class="tab-panel" style="display: none;">
                        <div class="control-group">
                            <h3>Parametri LFO</h3>

                            <div class="parameter">
                                <label for="lfo-shape">Forma d'onda LFO</label>
                                <select id="lfo-shape">
                                    <option value="0">TRI</option>
                                    <option value="1">SIN</option>
                                    <option value="2">SAW</option>
                                    <option value="3">SQR</option>
                                    <option value="4">S&H</option>
                                    <option value="5">RND</option>
                                </select>
                            </div>

                            <div class="parameter">
                                <label for="lfo-rate">Rate (0-127)</label>
                                <div class="slider-container">
                                    <input type="range" id="lfo-rate" min="0" max="127" value="40">
                                    <span class="value" id="lfo-rate-value">40</span>
                                </div>
                            </div>

                            <div class="parameter">
                                <label for="lfo-tempo-sync">Tempo Sync</label>
                                <select id="lfo-tempo-sync">
                                    <option value="0">OFF</option>
                                    <option value="1">ON</option>
                                </select>
                            </div>

                            <div class="parameter">
                                <label for="lfo-tempo-sync-note">Tempo Sync Note</label>
                                <select id="lfo-tempo-sync-note">
                                    <option value="0">16</option>
                                    <option value="1">12</option>
                                    <option value="2">8</option>
                                    <option value="3">4</option>
                                    <option value="4">2</option>
                                    <option value="5">1</option>
                                    <option value="6">3/4</option>
                                    <option value="7">2/3</option>
                                    <option value="8">1/2</option>
                                    <option value="9">3/8</option>
                                    <option value="10">1/3</option>
                                    <option value="11">1/4</option>
                                    <option value="12">3/16</option>
                                    <option value="13">1/6</option>
                                    <option value="14">1/8</option>
                                    <option value="15">3/32</option>
                                    <option value="16">1/12</option>
                                    <option value="17">1/16</option>
                                    <option value="18">1/24</option>
                                    <option value="19">1/32</option>
                                </select>
                            </div>

                            <div class="parameter">
                                <label for="lfo-fade-time">Fade Time (0-127)</label>
                                <div class="slider-container">
                                    <input type="range" id="lfo-fade-time" min="0" max="127" value="0">
                                    <span class="value" id="lfo-fade-time-value">0</span>
                                </div>
                            </div>

                            <div class="parameter">
                                <label for="lfo-pitch-depth">Pitch Depth (1-127) [-63 - +63]</label>
                                <div class="slider-container">
                                    <input type="range" id="lfo-pitch-depth" min="1" max="127" value="64">
                                    <span class="value" id="lfo-pitch-depth-value">0</span>
                                </div>
                            </div>

                            <div class="parameter">
                                <label for="lfo-filter-depth">Filter Depth (1-127) [-63 - +63]</label>
                                <div class="slider-container">
                                    <input type="range" id="lfo-filter-depth" min="1" max="127" value="64">
                                    <span class="value" id="lfo-filter-depth-value">0</span>
                                </div>
                            </div>

                            <div class="parameter">
                                <label for="lfo-amp-depth">Amp Depth (1-127) [-63 - +63]</label>
                                <div class="slider-container">
                                    <input type="range" id="lfo-amp-depth" min="1" max="127" value="64">
                                    <span class="value" id="lfo-amp-depth-value">0</span>
                                </div>
                            </div>
                        </div>

                        <div class="control-group">
                            <h3>Parametri Modulation LFO</h3>

                            <div class="parameter">
                                <label for="mod-lfo-shape">Forma d'onda Mod LFO</label>
                                <select id="mod-lfo-shape">
                                    <option value="0">TRI</option>
                                    <option value="1">SIN</option>
                                    <option value="2">SAW</option>
                                    <option value="3">SQR</option>
                                    <option value="4">S&H</option>
                                    <option value="5">RND</option>
                                </select>
                            </div>

                            <div class="parameter">
                                <label for="mod-lfo-rate">Rate (0-127)</label>
                                <div class="slider-container">
                                    <input type="range" id="mod-lfo-rate" min="0" max="127" value="40">
                                    <span class="value" id="mod-lfo-rate-value">40</span>
                                </div>
                            </div>

                            <div class="parameter">
                                <label for="mod-lfo-tempo-sync">Tempo Sync</label>
                                <select id="mod-lfo-tempo-sync">
                                    <option value="0">OFF</option>
                                    <option value="1">ON</option>
                                </select>
                            </div>

                            <div class="parameter">
                                <label for="mod-lfo-tempo-sync-note">Tempo Sync Note</label>
                                <select id="mod-lfo-tempo-sync-note">
                                    <option value="0">16</option>
                                    <option value="1">12</option>
                                    <option value="2">8</option>
                                    <option value="3">4</option>
                                    <option value="4">2</option>
                                    <option value="5">1</option>
                                    <option value="6">3/4</option>
                                    <option value="7">2/3</option>
                                    <option value="8">1/2</option>
                                    <option value="9">3/8</option>
                                    <option value="10">1/3</option>
                                    <option value="11">1/4</option>
                                    <option value="12">3/16</option>
                                    <option value="13">1/6</option>
                                    <option value="14">1/8</option>
                                    <option value="15">3/32</option>
                                    <option value="16">1/12</option>
                                    <option value="17">1/16</option>
                                    <option value="18">1/24</option>
                                    <option value="19">1/32</option>
                                </select>
                            </div>

                            <div class="parameter">
                                <label for="mod-lfo-pitch-depth">Pitch Depth (1-127) [-63 - +63]</label>
                                <div class="slider-container">
                                    <input type="range" id="mod-lfo-pitch-depth" min="1" max="127" value="64">
                                    <span class="value" id="mod-lfo-pitch-depth-value">0</span>
                                </div>
                            </div>

                            <div class="parameter">
                                <label for="mod-lfo-filter-depth">Filter Depth (1-127) [-63 - +63]</label>
                                <div class="slider-container">
                                    <input type="range" id="mod-lfo-filter-depth" min="1" max="127" value="64">
                                    <span class="value" id="mod-lfo-filter-depth-value">0</span>
                                </div>
                            </div>

                            <div class="parameter">
                                <label for="mod-lfo-amp-depth">Amp Depth (1-127) [-63 - +63]</label>
                                <div class="slider-container">
                                    <input type="range" id="mod-lfo-amp-depth" min="1" max="127" value="64">
                                    <span class="value" id="mod-lfo-amp-depth-value">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <button id="send-all-btn" class="send-all-btn">Invia tutti i parametri</button>

                <div class="logs">
                    <div class="log-entry info">Log eventi MIDI...</div>
                </div>
            </div>
        </div>

        <script>
            // DOM Elements
            const connectBtn = document.getElementById('connect-btn');
            const statusEl = document.getElementById('status');
            const sendAllBtn = document.getElementById('send-all-btn');
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabPanels = document.querySelectorAll('.tab-panel');
            const logsContainer = document.querySelector('.logs');

            const rdosc1 = document.getElementById('radioosc1') ;
            const rdosc0 = document.getElementById('radioosc0') ;
            const rdosc2 = document.getElementById('radioosc2') ;
            const rdosc3 = document.getElementById('radioosc3') ;
           
            rdosc1.disabled = true;
            rdosc0.disabled = true;
            rdosc2.disabled = true;
            rdosc3.disabled = true;

            // MIDI variables
            let midiAccess = null;
            let midiOutput = null;
            const ROLAND_MANUFACTURER_ID = 0x41;
            const DEVICE_ID = 0x10;
            const MODEL_ID = [0x00, 0x00, 0x71];
            const COMMAND_ID = 0x12;
            const UPPER_ID = [0x19, 0x41];
            OSCILLATOR_ID = 0x00;


            // Parameters mapping
            const parameterAddresses = {
                // Oscillator parameters
                'osc-wave': 0x00,
                'osc-wave-variation': 0x01,
                'osc-pitch': 0x03,
                'osc-detune': 0x04,
                'osc-pw-mod-depth': 0x05,
                'osc-pw': 0x06,
                'osc-pitch-env-attack': 0x07,
                'osc-pitch-env-decay': 0x08,
                'osc-pitch-env-depth': 0x09,

                // Filter parameters
                'filter-mode': 0x0A,
                'filter-slope': 0x0B,
                'filter-cutoff': 0x0C,
                'filter-cutoff-keyfollow': 0x0D,
                'filter-resonance': 0x0F,
                'filter-env-attack': 0x10,
                'filter-env-decay': 0x11,
                'filter-env-sustain': 0x12,
                'filter-env-release': 0x13,
                'filter-env-depth': 0x14,

                // LFO parameters
                'lfo-shape': 0x1C,
                'lfo-rate': 0x1D,
                'lfo-tempo-sync': 0x1E,
                'lfo-tempo-sync-note': 0x1F,
                'lfo-fade-time': 0x20,
                'lfo-pitch-depth': 0x22,
                'lfo-filter-depth': 0x23,
                'lfo-amp-depth': 0x24,

                // Modulation LFO parameters
                'mod-lfo-shape': 0x26,
                'mod-lfo-rate': 0x27,
                'mod-lfo-tempo-sync': 0x28,
                'mod-lfo-tempo-sync-note': 0x29,
                'mod-lfo-pitch-depth': 0x2C,
                'mod-lfo-filter-depth': 0x2D,
                'mod-lfo-amp-depth': 0x2E
            };

            // Bidirectional parameters (convert between display and actual values)
            const bidirectionalParams = [
                'osc-pitch', 'osc-detune', 'osc-pitch-env-depth',
                'filter-cutoff-keyfollow', 'filter-env-depth',
                'lfo-pitch-depth', 'lfo-filter-depth', 'lfo-amp-depth',
                'mod-lfo-pitch-depth', 'mod-lfo-filter-depth', 'mod-lfo-amp-depth'
            ];

            // Initialize all range inputs to update their displayed values
            document.querySelectorAll('input[type="range"]').forEach(slider => {
                const valueEl = document.getElementById(`${slider.id}-value`);
                if (!valueEl) return;

                // Set initial value
                if (bidirectionalParams.includes(slider.id)) {
                    const centerValue = (parseInt(slider.min) + parseInt(slider.max)) / 2;
                    valueEl.textContent = Math.round(parseInt(slider.value) - centerValue);
                } else {
                    valueEl.textContent = slider.value;
                }

                // Add event listener
                slider.addEventListener('input', () => {
                    if (bidirectionalParams.includes(slider.id)) {
                        const centerValue = (parseInt(slider.min) + parseInt(slider.max)) / 2;
                        valueEl.textContent = Math.round(parseInt(slider.value) - centerValue);
                    } else {
                        valueEl.textContent = slider.value;
                    }
                });
            });

            // Tab switching
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');

                    // Update active button
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    // Show active panel
                    tabPanels.forEach(panel => {
                        panel.style.display = panel.id === tabId ? 'block' : 'none';
                    });
                });
            });

            // Connect to MIDI devices
            connectBtn.addEventListener('click', async () => {
                try {
                    if (!midiAccess) {
                        if (navigator.requestMIDIAccess) {
                            midiAccess = await navigator.requestMIDIAccess({ sysex: true });
                            logMessage('Accesso MIDI ottenuto', 'success');
                            statusEl.textContent = 'Stato: Connesso al sistema MIDI';
                            connectBtn.textContent = 'Seleziona VR-09B';

                            // Now list available MIDI outputs
                            showMidiOutputSelection();
                        } else {
                            logMessage('Web MIDI API non supportata dal browser', 'error');
                            statusEl.textContent = 'Stato: API MIDI non supportata';
                        }
                    } else if (!midiOutput) {
                        showMidiOutputSelection();
                    } else {
                        // Already connected, do nothing or reconnect
                        midiOutput = null;
                        connectBtn.textContent = 'Seleziona VR-09B';
                        statusEl.textContent = 'Stato: Disconnesso dalla VR-09B';
                        showMidiOutputSelection();
                    }
                } catch (err) {
                    logMessage('Errore di connessione MIDI: ' + err.message, 'error');
                    statusEl.textContent = 'Stato: Errore di connessione';
                }
            });

            // Show MIDI output selection dialog

            function showMidiOutputSelection() {
                // Clear previous outputs list
                const existingSelect = document.getElementById('midi-output-select');
                if (existingSelect) {
                    existingSelect.remove();
                }

                // Create select element
                const selectEl = document.createElement('select');
                selectEl.id = 'midi-output-select';
                selectEl.style.margin = '10px 0';
                selectEl.style.width = '100%';
                selectEl.style.padding = '8px';

                // Add default option
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '-- Seleziona dispositivo MIDI --';
                selectEl.appendChild(defaultOption);

                // Add options for each MIDI output
                let hasOutputs = false;
                midiAccess.outputs.forEach(output => {
                    hasOutputs = true;
                    const option = document.createElement('option');
                    option.value = output.id;
                    option.textContent = output.name || `Dispositivo ${output.id}`;
                    selectEl.appendChild(option);
                });

                if (!hasOutputs) {
                    logMessage('Nessun dispositivo MIDI di output trovato', 'error');
                    return;
                }

                // Add to DOM before connect button
                connectBtn.parentNode.insertBefore(selectEl, connectBtn);

                // Add change event
                selectEl.addEventListener('change', (e) => {
                    const selectedId = e.target.value;
                    if (selectedId) {
                        midiOutput = midiAccess.outputs.get(selectedId);
                        statusEl.textContent = `Stato: Connesso a ${midiOutput.name || 'VR-09B'}`;
                        connectBtn.textContent = 'Disconnetti MIDI';
                        logMessage(`Connesso a ${midiOutput.name || 'VR-09B'}`, 'success');
                        selectEl.remove();
                    }
                });
            }

            // Send parameter value to VR-09B
            function sendParameterValue(paramId, value) {

                if (!midiOutput) {
                    logMessage('Nessun dispositivo MIDI connesso', 'error');
                    return false;
                }
                console.log('yes');
                const address = parameterAddresses[paramId];
                if (address === undefined) {
                    logMessage(`Indirizzo parametro sconosciuto: ${paramId}`, 'error');
                    return false;
                }

                try {
                    /*SELEZIONO L'OSCILLATORE*/
                    // Trova tutti i radiobutton con il nome 'osc-wave-variation'
                    const oscSelected = document.querySelectorAll('input[name="osc-wave-variation"]');

                    // Cerca quale radiobutton è selezionato
                    let selectedValue = null;
                    oscSelected.forEach((radio) => {
                        if (radio.checked) {
                            OSCILLATOR_ID = radio.value;
                        }
                    });
                    
                    // Format for Roland system exclusive message
                    // F0 41 10 00 00 00 0F address value checksum F7
                    const sysexMessage = [
                        0xF0,                // Start of SysEx
                        ROLAND_MANUFACTURER_ID, // Roland ID
                        DEVICE_ID,          // Device ID
                        ...MODEL_ID,        // Model ID
                        COMMAND_ID, 		//Command ID
                        ...UPPER_ID,			//upper 1941
                        OSCILLATOR_ID,      // Oscillator ID
                        address,            // Parameter address
                        parseInt(value),    // Parameter value
                        0x00,               // Checksum placeholder
                        0xF7                // End of SysEx
                    ];

                    // Calculate checksum (Roland format)
                    let checksum = 0;
                    for (let i = 1; i < sysexMessage.length - 2; i++) {
                        checksum += sysexMessage[i];
                    }
                    checksum = 128 - (checksum % 128);
                    sysexMessage[sysexMessage.length - 2] = checksum;

                    // Send the message
                    //midiOutput.send(sysexMessage);
                    midiOutput.send(new Uint8Array(sysexMessage));
                    console.log(paramId);
                    logMessage(`Parametro inviato: ${paramId} = ${value} - ` + formatSysEx(sysexMessage), 'info');

                    return true;
                } catch (error) {
                    logMessage(`Errore nell'invio del parametro: ${error.message}`, 'error');
                    return false;
                }
            }

            // accende o spegne l'oscilallatore
            function setOscOn(osc, status) {

                if (!midiOutput) {
                    logMessage('Nessun dispositivo MIDI connesso', 'error');
                    return false;
                }
                const address = parameterAddresses['osc-wave'];

                OSCILLATOR_ID = parseInt(osc);
                try {

                    // Format for Roland system exclusive message
                    // F0 41 10 00 00 00 0F address value checksum F7
                    const sysexMessage = [
                        0xF0,                // Start of SysEx
                        ROLAND_MANUFACTURER_ID, // Roland ID
                        DEVICE_ID,          // Device ID
                        ...MODEL_ID,        // Model ID
                        COMMAND_ID, 		//Command ID
                        ...UPPER_ID,			//upper 1941
                        address,      // Parameter address
                        OSCILLATOR_ID,            // Oscillator ID
                        parseInt(status),    // Parameter value
                        0x00,               // Checksum placeholder
                        0xF7                // End of SysEx
                    ];

                    // Calculate checksum (Roland format)
                    let checksum = 0;
                    for (let i = 1; i < sysexMessage.length - 2; i++) {
                        checksum += sysexMessage[i];
                    }
                    checksum = 128 - (checksum % 128);
                    sysexMessage[sysexMessage.length - 2] = checksum;

                    // Send the message
                    //midiOutput.send(sysexMessage);                    
                    midiOutput.send(new Uint8Array(sysexMessage));
                    logMessage(`Parametro inviato: ${paramId} = ` + formatSysEx(sysexMessage), 'info');
                    return true;
                } catch (error) {             
                    logMessage(`Errore nell'invio del parametro: ${error.message}`, 'error');
                    return false;
                }
            }

            function formatSysEx(sysex) {
                return Array.from(sysex)
                    .map(byte => byte.toString(16).padStart(2, '0').toUpperCase()) // Formatta ogni byte in esadecimale
                    .join(' '); // Inserisce uno spazio tra i byte
            }

            // Send all parameters to the VR-09B
            sendAllBtn.addEventListener('click', () => {
                if (!midiOutput) {
                    logMessage('Nessun dispositivo MIDI connesso', 'error');
                    return;
                }

                let successCount = 0;
                let failCount = 0;

                // Process all inputs
                document.querySelectorAll('select, input[type="range"]').forEach(element => {
                    if (element.id !== 'midi-output-select') {
                        const result = sendParameterValue(element.id, element.value);
                        if (result) {
                            successCount++;
                        } else {
                            failCount++;
                        }
                    }
                });

                logMessage(`Invio completato: ${successCount} parametri inviati, ${failCount} falliti`,
                    failCount > 0 ? 'error' : 'success');
            });

            // Add event listeners to all parameters for real-time control
            document.querySelectorAll('select, input[type="range"]').forEach(element => {
     
                if (element.id !== 'midi-output-select') {
                    element.addEventListener('change', () => {
                        if (midiOutput) {
                            sendParameterValue(element.id, element.value);
                        }
                    });

                    // For sliders, also update while dragging
                    if (element.type === 'range') {
                        element.addEventListener('input', () => {
                            if (!midiOutput) {
                                sendParameterValue(element.id, element.value);
                            }
                        });
                    }
                }
            });
          
            function updateOscillatorStatus() {
                const oscWaveVariationSelect = document.getElementById('osc-wave-variation');
                const osc1 = document.getElementById('switch1').checked;
                const osc2 = document.getElementById('switch2').checked;
                const osc3 = document.getElementById('switch3').checked;                      

                // Abilita o no i radio button in base allo stato degli switch
                if (osc1) {
                    rdosc1.disabled = false;
                    logMessage('osc1-on', 'info');
                    setOscOn('25', '1');
                } else {
                    rdosc1.disabled = true;
                    logMessage('osc1-off', 'info');
                    setOscOn('25', '0');
                }
                if (osc2) {
                    rdosc2.disabled = false;
                    logMessage('osc2-on', 'info');
                    setOscOn('27', '1');
                }
                else {
                    rdosc2.disabled = true;
                    logMessage('osc2-off', 'info');
                    setOscOn('27', '0');

                }
                if (osc3) {
                    rdosc3.disabled = false;
                    logMessage('osc3-on', 'info');
                    setOscOn('29', '1');

                }
                else {
                    rdosc3.disabled = true;
                    logMessage('osc3-off', 'info');
                    setOscOn('29', '0');

                }

                // Add default option if no oscillators are ON
                if (osc1 || osc2 || osc3) {                   
                    rdosc0.disabled = false;
                }else {
                    rdosc0.disabled = true;
                }

            }
            // Add event listeners to update status when checkboxes are toggled
            document.getElementById('switch1').addEventListener('change', updateOscillatorStatus);
            document.getElementById('switch2').addEventListener('change', updateOscillatorStatus);
            document.getElementById('switch3').addEventListener('change', updateOscillatorStatus);



            // Helper function to log messages
            function logMessage(message, type = 'info') {
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${type}`;
                logEntry.textContent = message;

                // Add timestamp
                const now = new Date();
                const timestamp = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
                logEntry.textContent = `[${timestamp}] ${message}`;

                // Add to log container
                logsContainer.appendChild(logEntry);

                // Auto-scroll to bottom
                logsContainer.scrollTop = logsContainer.scrollHeight;

                // Limit number of log entries
                const maxLogEntries = 50;
                while (logsContainer.children.length > maxLogEntries) {
                    logsContainer.removeChild(logsContainer.firstChild);
                }
            }

            // Check for Web MIDI API support on page load
            window.addEventListener('load', () => {
                if (!navigator.requestMIDIAccess) {
                    logMessage('Il browser non supporta Web MIDI API', 'error');
                    statusEl.textContent = 'Stato: Web MIDI API non supportata';
                    connectBtn.disabled = true;
                } else {
                    logMessage('Web MIDI API supportata. Premi "Connetti MIDI" per iniziare.', 'info');
                }
            });

        </script>
</body>

</html>